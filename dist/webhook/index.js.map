{"version":3,"sources":["../../src/webhook/stripe.ts","../../src/stripe/server.ts","../../src/env/server.ts","../../src/supabase/admin.ts","../../src/billing/plans.ts"],"sourcesContent":["import Stripe from 'stripe'\nimport { headers } from 'next/headers'\nimport { stripe } from '../stripe/server'\nimport { createAdminClient } from '../supabase/admin'\nimport { getFlagsForPriceIds, subscriptionFlagSet } from '../billing/plans'\nimport { env } from '../env/server'\n\nconst toIsoString = (unixSeconds: number | null) => {\n  if (!unixSeconds) return null\n  return new Date(unixSeconds * 1000).toISOString()\n}\n\nconst getProfileFlagsForCustomer = async (stripeCustomerId: string) => {\n  const supabase = createAdminClient()\n\n  const { data, error } = await supabase\n    .from('profiles')\n    .select('feature_flags')\n    .eq('stripe_customer_id', stripeCustomerId)\n    .single()\n\n  if (error) {\n    throw error\n  }\n\n  return Array.isArray(data?.feature_flags) ? (data.feature_flags as string[]) : []\n}\n\nconst updateProfileForCustomer = async (\n  stripeCustomerId: string,\n  updates: Record<string, unknown>\n) => {\n  const supabase = createAdminClient()\n\n  const { error } = await supabase\n    .from('profiles')\n    .update(updates)\n    .eq('stripe_customer_id', stripeCustomerId)\n\n  if (error) {\n    throw error\n  }\n}\n\nconst handlePaymentIntentSucceeded = async (paymentIntent: Stripe.PaymentIntent) => {\n  const priceId = paymentIntent.metadata?.price_id\n  if (!priceId || !paymentIntent.customer) return\n\n  const flags = getFlagsForPriceIds([priceId])\n  const currentFlags = await getProfileFlagsForCustomer(String(paymentIntent.customer))\n  const nextFlags = Array.from(new Set([...currentFlags, ...flags]))\n\n  await updateProfileForCustomer(String(paymentIntent.customer), {\n    feature_flags: nextFlags\n  })\n}\n\nconst handleSubscriptionUpdate = async (subscription: Stripe.Subscription) => {\n  if (!subscription.customer) return\n\n  const priceIds = subscription.items.data\n    .map((item) => item.price?.id)\n    .filter((id): id is string => Boolean(id))\n\n  const flags = getFlagsForPriceIds(priceIds)\n  const currentFlags = await getProfileFlagsForCustomer(String(subscription.customer))\n  const retainedFlags = currentFlags.filter((flag) => !subscriptionFlagSet.has(flag))\n  const nextFlags = Array.from(new Set([...retainedFlags, ...flags]))\n\n  await updateProfileForCustomer(String(subscription.customer), {\n    stripe_subscription_id: subscription.id,\n    stripe_subscription_status: subscription.status,\n    stripe_price_id: priceIds[0] ?? null,\n    stripe_current_period_end: toIsoString(subscription.current_period_end),\n    stripe_trial_end: toIsoString(subscription.trial_end),\n    feature_flags: nextFlags\n  })\n}\n\nconst handleSubscriptionDeleted = async (subscription: Stripe.Subscription) => {\n  if (!subscription.customer) return\n\n  const currentFlags = await getProfileFlagsForCustomer(String(subscription.customer))\n  const retainedFlags = currentFlags.filter((flag) => !subscriptionFlagSet.has(flag))\n\n  await updateProfileForCustomer(String(subscription.customer), {\n    stripe_subscription_id: subscription.id,\n    stripe_subscription_status: subscription.status,\n    stripe_current_period_end: toIsoString(subscription.current_period_end),\n    feature_flags: retainedFlags\n  })\n}\n\nconst handleInvoicePaid = async (invoice: Stripe.Invoice) => {\n  if (!invoice.subscription) return\n\n  const subscription = await stripe.subscriptions.retrieve(\n    typeof invoice.subscription === 'string'\n      ? invoice.subscription\n      : invoice.subscription.id\n  )\n\n  await handleSubscriptionUpdate(subscription)\n}\n\nconst handleCheckoutSessionCompleted = async (session: Stripe.Checkout.Session) => {\n  // For one-time payments, check if there's a payment intent\n  if (session.mode === 'payment' && session.payment_intent) {\n    const paymentIntent = await stripe.paymentIntents.retrieve(\n      typeof session.payment_intent === 'string'\n        ? session.payment_intent\n        : session.payment_intent.id\n    )\n    await handlePaymentIntentSucceeded(paymentIntent)\n  }\n  \n  // For subscriptions, the subscription events will handle it\n  // but we can also handle it here as a backup\n  if (session.mode === 'subscription' && session.subscription) {\n    const subscription = await stripe.subscriptions.retrieve(\n      typeof session.subscription === 'string'\n        ? session.subscription\n        : session.subscription.id\n    )\n    await handleSubscriptionUpdate(subscription)\n  }\n}\n\nexport async function POST(request: Request) {\n  const body = await request.text()\n  const headerStore = await headers()\n  const signature = headerStore.get('stripe-signature')\n\n  if (!signature) {\n    return new Response('Missing stripe signature', { status: 400 })\n  }\n\n  let event: Stripe.Event\n  try {\n    event = stripe.webhooks.constructEvent(\n      body,\n      signature,\n      env.STRIPE_WEBHOOK_SECRET\n    )\n  } catch (error) {\n    const message =\n      error instanceof Error ? error.message : 'Webhook signature failed.'\n    return new Response(message, { status: 400 })\n  }\n\n  try {\n    switch (event.type) {\n      case 'payment_intent.succeeded':\n        await handlePaymentIntentSucceeded(event.data.object as Stripe.PaymentIntent)\n        break\n      case 'invoice.paid':\n        await handleInvoicePaid(event.data.object as Stripe.Invoice)\n        break\n      case 'customer.subscription.created':\n      case 'customer.subscription.updated':\n        await handleSubscriptionUpdate(event.data.object as Stripe.Subscription)\n        break\n      case 'customer.subscription.deleted':\n        await handleSubscriptionDeleted(event.data.object as Stripe.Subscription)\n        break\n      case 'checkout.session.completed':\n        await handleCheckoutSessionCompleted(event.data.object as Stripe.Checkout.Session)\n        break\n      default:\n        break\n    }\n  } catch (error) {\n    const message = error instanceof Error ? error.message : 'Webhook error.'\n    return new Response(message, { status: 500 })\n  }\n\n  return new Response('ok', { status: 200 })\n}\n","import Stripe from 'stripe'\nimport { env } from '../env/server'\n\nexport const stripe = new Stripe(env.STRIPE_SECRET_KEY, {\n  apiVersion: '2024-06-20'\n})\n","import 'server-only'\nimport { z } from 'zod'\n\nconst envSchema = z.object({\n  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),\n  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),\n  SUPABASE_SERVICE_ROLE_KEY: z.string().min(1).optional(),\n  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: z.string().min(1),\n  STRIPE_SECRET_KEY: z.string().min(1),\n  STRIPE_WEBHOOK_SECRET: z.string().min(1),\n  STRIPE_PRICE_CONTENT_PACK: z.string().min(1),\n  STRIPE_PRICE_PRO_MONTHLY: z.string().min(1),\n  STRIPE_PRICE_PRO_ANNUAL: z.string().min(1),\n  STRIPE_USE_CHECKOUT: z.string().optional().transform((val) => val !== 'false').default('true'),\n  NODE_ENV: z.enum(['development', 'production', 'test']).default('development')\n})\n\nexport const env = envSchema.parse(process.env)\n","import { createClient } from '@supabase/supabase-js'\nimport { env } from '../env/server'\n\nexport const createAdminClient = () => {\n  if (!env.SUPABASE_SERVICE_ROLE_KEY) {\n    throw new Error('SUPABASE_SERVICE_ROLE_KEY is required for admin operations.')\n  }\n\n  return createClient(env.NEXT_PUBLIC_SUPABASE_URL, env.SUPABASE_SERVICE_ROLE_KEY)\n}\n","import { env } from '../env/server'\nimport { stripe } from '../stripe/server'\n\nexport type BillingPlan = {\n  id: 'content_pack' | 'pro_monthly' | 'pro_annual'\n  name: string\n  description: string\n  priceId: string\n  amount: number\n  currency: 'gbp'\n  interval: 'one_time' | 'month' | 'year'\n  flags: string[]\n}\n\nexport const billingPlans: BillingPlan[] = [\n  {\n    id: 'content_pack',\n    name: 'Content Pack',\n    description: 'One-time access to premium content.',\n    priceId: env.STRIPE_PRICE_CONTENT_PACK,\n    amount: 1500,\n    currency: 'gbp',\n    interval: 'one_time',\n    flags: ['content_pack']\n  },\n  {\n    id: 'pro_monthly',\n    name: 'Pro Monthly',\n    description: 'Monthly subscription with downloads.',\n    priceId: env.STRIPE_PRICE_PRO_MONTHLY,\n    amount: 1200,\n    currency: 'gbp',\n    interval: 'month',\n    flags: ['pro_content', 'download_access']\n  },\n  {\n    id: 'pro_annual',\n    name: 'Pro Annual',\n    description: 'Annual subscription with support.',\n    priceId: env.STRIPE_PRICE_PRO_ANNUAL,\n    amount: 12000,\n    currency: 'gbp',\n    interval: 'year',\n    flags: ['pro_content', 'download_access', 'priority_support']\n  }\n]\n\nexport const getBillingPlansWithStripePricing = async () => {\n  'use server'\n  const plans = await Promise.all(\n    billingPlans.map(async (plan) => {\n      try {\n        const stripePrice = await stripe.prices.retrieve(plan.priceId)\n        if (typeof stripePrice.unit_amount === 'number') {\n          return {\n            ...plan,\n            amount: stripePrice.unit_amount\n          }\n        }\n      } catch {\n        return plan\n      }\n\n      return plan\n    })\n  )\n\n  return plans\n}\n\nexport const getFlagsForPriceIds = (priceIds: string[]) => {\n  const flags = new Set<string>()\n\n  billingPlans.forEach((plan) => {\n    if (priceIds.includes(plan.priceId)) {\n      plan.flags.forEach((flag) => flags.add(flag))\n    }\n  })\n\n  return Array.from(flags)\n}\n\nexport const subscriptionFlagSet = new Set(\n  billingPlans\n    .filter((plan) => plan.interval !== 'one_time')\n    .flatMap((plan) => plan.flags)\n)\n"],"mappings":"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","names":[]}