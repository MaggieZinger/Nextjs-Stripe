{"version":3,"sources":["../../src/supabase/server.ts","../../src/stripe/server.ts","../../src/env/server.ts","../../src/billing/plans.ts","../../src/billing/actions.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\nimport type { SetAllCookies } from '@supabase/ssr'\nimport { cookies } from 'next/headers'\n\nexport const createClient = async () => {\n  const cookieStore = await cookies()\n\n  return createServerClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        getAll: () => cookieStore.getAll(),\n        setAll: (cookiesToSet: Parameters<SetAllCookies>[0]) => {\n          cookiesToSet.forEach(({ name, value, options }) =>\n            cookieStore.set(name, value, options)\n          )\n        }\n      }\n    }\n  )\n}\n","import Stripe from 'stripe'\nimport { env } from '../env/server'\n\nexport const stripe = new Stripe(env.STRIPE_SECRET_KEY, {\n  apiVersion: '2024-06-20'\n})\n","import 'server-only'\nimport { z } from 'zod'\n\nconst envSchema = z.object({\n  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),\n  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),\n  SUPABASE_SERVICE_ROLE_KEY: z.string().min(1).optional(),\n  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: z.string().min(1),\n  STRIPE_SECRET_KEY: z.string().min(1),\n  STRIPE_WEBHOOK_SECRET: z.string().min(1),\n  STRIPE_PRICE_CONTENT_PACK: z.string().min(1),\n  STRIPE_PRICE_PRO_MONTHLY: z.string().min(1),\n  STRIPE_PRICE_PRO_ANNUAL: z.string().min(1),\n  NODE_ENV: z.enum(['development', 'production', 'test']).default('development')\n})\n\nexport const env = envSchema.parse(process.env)\n","import { env } from '../env/server'\nimport { stripe } from '../stripe/server'\n\nexport type BillingPlan = {\n  id: 'content_pack' | 'pro_monthly' | 'pro_annual'\n  name: string\n  description: string\n  priceId: string\n  amount: number\n  currency: 'gbp'\n  interval: 'one_time' | 'month' | 'year'\n  flags: string[]\n}\n\nexport const billingPlans: BillingPlan[] = [\n  {\n    id: 'content_pack',\n    name: 'Content Pack',\n    description: 'One-time access to premium content.',\n    priceId: env.STRIPE_PRICE_CONTENT_PACK,\n    amount: 1500,\n    currency: 'gbp',\n    interval: 'one_time',\n    flags: ['content_pack']\n  },\n  {\n    id: 'pro_monthly',\n    name: 'Pro Monthly',\n    description: 'Monthly subscription with downloads.',\n    priceId: env.STRIPE_PRICE_PRO_MONTHLY,\n    amount: 1200,\n    currency: 'gbp',\n    interval: 'month',\n    flags: ['pro_content', 'download_access']\n  },\n  {\n    id: 'pro_annual',\n    name: 'Pro Annual',\n    description: 'Annual subscription with support.',\n    priceId: env.STRIPE_PRICE_PRO_ANNUAL,\n    amount: 12000,\n    currency: 'gbp',\n    interval: 'year',\n    flags: ['pro_content', 'download_access', 'priority_support']\n  }\n]\n\nexport const getBillingPlansWithStripePricing = async () => {\n  'use server'\n  const plans = await Promise.all(\n    billingPlans.map(async (plan) => {\n      try {\n        const stripePrice = await stripe.prices.retrieve(plan.priceId)\n        if (typeof stripePrice.unit_amount === 'number') {\n          return {\n            ...plan,\n            amount: stripePrice.unit_amount\n          }\n        }\n      } catch {\n        return plan\n      }\n\n      return plan\n    })\n  )\n\n  return plans\n}\n\nexport const getFlagsForPriceIds = (priceIds: string[]) => {\n  const flags = new Set<string>()\n\n  billingPlans.forEach((plan) => {\n    if (priceIds.includes(plan.priceId)) {\n      plan.flags.forEach((flag) => flags.add(flag))\n    }\n  })\n\n  return Array.from(flags)\n}\n\nexport const subscriptionFlagSet = new Set(\n  billingPlans\n    .filter((plan) => plan.interval !== 'one_time')\n    .flatMap((plan) => plan.flags)\n)\n","import { createClient } from '../supabase/server'\nimport { stripe } from '../stripe/server'\nimport { billingPlans } from './plans'\n\nconst getPlanByPriceId = (priceId: string) =>\n  billingPlans.find((plan) => plan.priceId === priceId)\n\nconst ensureStripeCustomer = async (userId: string, email?: string | null) => {\n  const supabase = await createClient()\n\n  const { data: profile, error } = await supabase\n    .from('profiles')\n    .select('stripe_customer_id')\n    .eq('id', userId)\n    .single()\n\n  if (error) {\n    throw error\n  }\n\n  if (profile?.stripe_customer_id) {\n    return profile.stripe_customer_id\n  }\n\n  const customer = await stripe.customers.create({\n    email: email ?? undefined,\n    metadata: {\n      supabase_user_id: userId\n    }\n  })\n\n  const { error: updateError } = await supabase\n    .from('profiles')\n    .update({ stripe_customer_id: customer.id })\n    .eq('id', userId)\n\n  if (updateError) {\n    throw updateError\n  }\n\n  return customer.id\n}\n\nexport async function createPaymentIntent(priceId: string) {\n  'use server'\n  const supabase = await createClient()\n  const { data: userData, error: userError } = await supabase.auth.getUser()\n\n  if (userError || !userData?.user) {\n    return { error: 'Not authenticated.' }\n  }\n\n  const plan = getPlanByPriceId(priceId)\n  if (!plan || plan.interval !== 'one_time') {\n    return { error: 'Invalid price selection.' }\n  }\n\n  const customerId = await ensureStripeCustomer(\n    userData.user.id,\n    userData.user.email\n  )\n\n  const stripePrice = await stripe.prices.retrieve(priceId)\n  if (\n    !stripePrice.unit_amount ||\n    stripePrice.currency !== plan.currency ||\n    stripePrice.type !== 'one_time'\n  ) {\n    return { error: 'Price configuration error.' }\n  }\n\n  const paymentIntent = await stripe.paymentIntents.create({\n    amount: stripePrice.unit_amount,\n    currency: stripePrice.currency,\n    customer: customerId,\n    automatic_payment_methods: { enabled: true },\n    metadata: {\n      price_id: priceId,\n      supabase_user_id: userData.user.id\n    }\n  })\n\n  return { clientSecret: paymentIntent.client_secret }\n}\n\nexport async function createSubscription(priceId: string) {\n  'use server'\n  const supabase = await createClient()\n  const { data: userData, error: userError } = await supabase.auth.getUser()\n\n  if (userError || !userData?.user) {\n    return { error: 'Not authenticated.' }\n  }\n\n  const plan = getPlanByPriceId(priceId)\n  if (!plan || plan.interval === 'one_time') {\n    return { error: 'Invalid price selection.' }\n  }\n\n  const customerId = await ensureStripeCustomer(\n    userData.user.id,\n    userData.user.email\n  )\n\n  const subscription = await stripe.subscriptions.create({\n    customer: customerId,\n    items: [{ price: priceId }],\n    payment_behavior: 'default_incomplete',\n    payment_settings: { save_default_payment_method: 'on_subscription' },\n    expand: ['latest_invoice.payment_intent'],\n    metadata: {\n      price_id: priceId,\n      supabase_user_id: userData.user.id\n    }\n  })\n\n  if (!subscription.latest_invoice || typeof subscription.latest_invoice === 'string') {\n    return { error: 'Subscription payment could not be initialized.' }\n  }\n\n  const paymentIntent = subscription.latest_invoice.payment_intent\n  if (!paymentIntent || typeof paymentIntent === 'string') {\n    return { error: 'Subscription payment could not be initialized.' }\n  }\n\n  return {\n    clientSecret: paymentIntent.client_secret,\n    subscriptionId: subscription.id\n  }\n}\n\nexport async function getBillingProfile() {\n  'use server'\n  const supabase = await createClient()\n  const { data: userData, error: userError } = await supabase.auth.getUser()\n\n  if (userError || !userData?.user) {\n    return { error: 'Not authenticated.' }\n  }\n\n  const { data: profile, error } = await supabase\n    .from('profiles')\n    .select(\n      'stripe_subscription_status, stripe_current_period_end, feature_flags'\n    )\n    .eq('id', userData.user.id)\n    .single()\n\n  if (error) {\n    return { error: error.message }\n  }\n\n  return { profile }\n}\n"],"mappings":"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","names":[]}